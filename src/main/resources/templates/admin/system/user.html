<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>用户管理</title>
    <link rel="stylesheet" href="admin/libs/layui/css/layui.css" th:href="@{/admin/assets/libs/layui/css/layui.css}"/>
    <link rel="stylesheet" href="admin/module/admin.css?v=318" th:href="@{/admin/assets/module/admin.css(v=318)}"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <!-- 表格工具栏 -->
            <form class="layui-form toolbar" autocomplete="off">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">用户名:</label>
                        <div class="layui-input-inline">
                            <input name="username" class="layui-input" placeholder="输入用户名"/>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">手机号:</label>
                        <div class="layui-input-inline">
                            <input name="phone" class="layui-input" placeholder="输入手机号"/>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">时间段:</label>
                        <div class="layui-input-inline">
                            <select name="state">
                                <option value="0" selected="selected">选择查找时间段</option>
                                <option value="1" >注册时间</option>
                                <option value="2">登录时间</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
<!--                        <label class="layui-form-label">输入时间段:</label>-->
                        <div >
                            <input name="Time" id="Time"class="layui-input"  size="50"/>
                        </div>
                    </div>

                    <div class="layui-inline">&emsp;
                        <button class="layui-btn icon-btn" lay-filter="userTbSearch" lay-submit>
                            <i class="layui-icon">&#xe615;</i>搜索
                        </button>
                    </div>
                </div>
            </form>
            <!-- 数据表格 -->
            <table id="userTable" lay-filter="userTable"></table>
            <style type="text/css">
                /*正确显示图片的style*/
                .layui-table-cell{

                    text-align:center;

                    height: auto;

                    white-space: normal;

                }

                .layui-table img{

                    max-width:300px

                }
            </style>

        </div>
    </div>
</div>
<!--头像操作显示-->
<script type="text/html" id="imgtmp">
    <img src="{{ d.photo}}"  style="height:50px;width:50px">
</script>
<!-- 表格操作列 -->
<script type="text/html" id="userTbBar">
<!--    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>-->
<!--    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>-->
    <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="reset">重置密码</a>
</script>
<!-- 表格状态列 -->
<script type="text/html" id="userTbState">
    <input type="checkbox" lay-filter="userTbStateCk" value="{{d.username}}" lay-skin="switch"

           lay-text="正常|拉黑" {{d.startTime==null?'checked':''}} style="display: none;"
    data-q="{{d.id}}"/>
<!--    <p style="display: none;">{{d.startTime!=null?'正常':'锁定'}}</p>-->
</script>
<!-- 表单弹窗 -->
<script type="text/html" id="userEditDialog">
    <form id="userEditForm" lay-filter="userEditForm" class="layui-form model-form" autocomplete="off">
<!--        操作人id-->
        <input name="adminId" type="hidden" value="1"/>
        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">用户id:</label>
            <div class="layui-input-block">
                <input name="id" value=" " class="layui-input"
                       lay-verType="tips" lay-verify="required"
                       readonly required/>
            </div>
        </div>



        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">封禁时长:</label>
            <div class="layui-input-block">
                <input name="data" placeholder="请选择封禁时间" class="layui-input"
                       lay-verType="tips" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label layui-form-required">封禁原因:</label>
            <div class="layui-input-block">
                <textarea name="reason" placeholder="请输入封禁原因" class="layui-textarea"
                          lay-verType="tips" lay-verify="required" required></textarea>
            </div>
        </div>

        <div class="layui-form-item text-right">
            <button class="layui-btn" lay-filter="userEditSubmit" lay-submit>确定</button>
<!--            <button class="layui-btn layui-btn-primary" type="button"  ew-event="closeDialog">取消</button>-->
        </div>
    </form>
</script>

<!-- js部分 -->
<script type="text/javascript" src="admin/libs/layui/layui.js" th:src="@{/admin/assets/libs/layui/layui.js}"></script>
<script type="text/javascript" src="admin/js/common.js?v=318" th:src="@{/admin/assets/js/common.js(v=318)}"></script>
<script th:inline="none">
    layui.use(['layer', 'form', 'table', 'util', 'admin','laydate', 'xmSelect'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var table = layui.table;
        var util = layui.util;
        var admin = layui.admin;
        var xmSelect = layui.xmSelect;
        var laydate = layui.laydate;


        /* 渲染表格 */
        var insTb = table.render({
            elem: '#userTable',
            url: '/admin/system/user/table',
            response: {
                statusCode: 2000 //规定成功的状态码，默认：0

            },
            parseData: function(res){ //res 即为原始返回的数据
            return {
                "code": res.code, //解析接口状态
                "msg": res.message, //解析提示文本
                "count": res.data.total, //解析数据长度
                "data": res.data.list //解析数据列表
                };
            },
           // where: {token: 'sasasas', id: 123},
            page: true,

            cellMinWidth: 100,
            cols: [[

                {field: 'username', title: '用户名', sort: true,style:'height:50px'},
                {field: 'email', title: '邮箱', sort: true},
                {field: 'phone', title: '手机号', sort: true},
                {field: 'gender', title: '性别', sort: true},
                {field: 'photo', title: '头像', templet: "#imgtmp"},

                {
                    field: 'registerTime', title: '注册时间', templet: function (d) {
                        return util.toDateString(d.registerTime);
                    }, sort: true
                },
                {
                    field: 'lastLoginTime', title: '上一次登录时间', templet: function (d) {
                        return util.toDateString(d.lastLoginTime);
                    }, sort: true
                },
                {title: '状态', templet: '#userTbState', sort: true, width: 100},
                {title: '操作', toolbar: '#userTbBar', align: 'center', minWidth: 200}
            ]],



        });

        /* 表格搜索 */
        form.on('submit(userTbSearch)', function (data) {
           // console.log(data);
            console.log(data.field);
            // var loadIndex = layer.load(2);
            //
            // var url = '/admin/system/user/table';
            // $.get(url, data.field, function (res) {
            //     layer.close(loadIndex);
            //     if (res.code === 2000) {
            //         //layer.close(dIndex);
            //         layer.msg(res.msg, {icon: 1});
            //         // insTb.refresh();
            //     } else {
            //         layer.msg(res.msg, {icon: 2});
            //     }
            // }, 'json');
            insTb.reload({where: data.field, page: {curr: 1}});
            return false;


            // return false;
        });

        laydate.render({
            elem: '#Time',
            type: 'datetime',
            range: true
        });


        /* 表格工具条点击事件 */
        table.on('tool(userTable)', function (obj) {
        if (obj.event === 'reset') { // 重置密码
                resetPsw(obj);
            }
        });


        /* 显示表单弹窗 */
        function showEditModel(mData,q) {

            admin.open({
                type: 1,
                title: '将'+mData.elem.value+'加入黑名单',
                area: "600px",
                content: $('#userEditDialog').html(),
                success: function (layero, dIndex) {
                    // 回显表单数据
                    form.val('userEditForm', {id:q});
                    // 表单提交事件
                    form.on('submit(userEditSubmit)', function (data) {
                        console.log(data.field);
                        var loadIndex = layer.load(2);

                        var url = '/admin/system/user/block';
                        $.post(url, data.field, function (res) {
                            layer.close(loadIndex);
                            if (res.code === 2000) {
                                layer.close(dIndex);
                                layer.msg(res.msg, {icon: 1});
                               // insTb.refresh();
                            } else {
                                layer.msg(res.msg, {icon: 2});
                            }
                        }, 'json');
                        return false;
                    });

                    // 日期选择器
                    laydate.render({
                        elem: '#userEditForm input[name="data"]',
                        type: 'datetime',
                        range: true,
                        trigger: 'click'
                        ,min: 0
                    });


                    // 禁止弹窗出现滚动条
                    $(layero).children('.layui-layer-content').css('overflow', 'visible');
                },


                cancel: function(index, layero){
                    mData.elem.checked=true;
                    form.render();

                },



            });
        }




        /* 修改用户状态,拉黑与否 */
        form.on('switch(userTbStateCk)', function (obj) {
            console.log(obj);
            var i=obj.elem.checked ? 0 : 1;
            var q=$(this).data('q');
            if(i==0){

                layer.confirm('确定要将' + obj.elem.value +'取消拉黑吗？', {
                    btn: ["确定","取消"] ,//按钮
                    skin: 'layui-layer-admin',
                    shade: .1,
                    cancel: function() {
                        console.log("您点击了关闭");
                        obj.elem.checked=false;
                        form.render();
                    }
                }, function () {
                    layer.close(i);
                    var loadIndex = layer.load(2);
                    $.post('/admin/system/user/cancelblock', {
                        userId: q
                    }, function (res) {
                        layer.close(loadIndex);
                        if (res.code === 2000) {
                            layer.msg(res.msg, {icon: 1});
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    }, 'json');
                }
                ,function (){
                        obj.elem.checked=false;
                        form.render();
                });

            }else{

                showEditModel(obj,q);
            }

        });

        /* 重置密码 */
        function resetPsw(obj) {
            layer.confirm('确定要重置“' + obj.data.username + '”的登录密码吗？', {
                skin: 'layui-layer-admin',
                shade: .1
            }, function (i) {
                layer.close(i);
                var loadIndex = layer.load(2);
                $.post('/admin/system/user/resetpsw', {
                    userId: obj.data.id
                }, function (res) {
                    layer.close(loadIndex);
                    if (res.code === 2000) {
                        layer.msg(res.msg, {icon: 1});
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                }, 'json');
            });
        }

    });
</script>

</body>
</html>
